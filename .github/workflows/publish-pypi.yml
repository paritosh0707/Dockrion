name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to publish (or "all" for all packages)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - common-py
          - telemetry
          - schema
          - policy-engine
          - adapters
          - runtime
          - sdk-python
          - cli
          - dockrion
      use_token:
        description: 'Use API token instead of trusted publisher (for first publish)'
        required: false
        default: false
        type: boolean

jobs:
  # Build all packages first
  build:
    name: Build Packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build tools
        run: |
          pip install --upgrade pip
          pip install build twine

      - name: Build common-py
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'common-py'
        run: |
          cd packages/common-py
          python -m build
          ls -la dist/

      - name: Build telemetry
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'telemetry'
        run: |
          cd packages/telemetry
          python -m build
          ls -la dist/

      - name: Build schema
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'schema'
        run: |
          cd packages/schema
          python -m build
          ls -la dist/

      - name: Build policy-engine
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'policy-engine'
        run: |
          cd packages/policy-engine
          python -m build
          ls -la dist/

      - name: Build adapters
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'adapters'
        run: |
          cd packages/adapters
          python -m build
          ls -la dist/

      - name: Build runtime
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'runtime'
        run: |
          cd packages/runtime
          python -m build
          ls -la dist/

      - name: Build sdk-python
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'sdk-python'
        run: |
          cd packages/sdk-python
          python -m build
          ls -la dist/

      - name: Build cli
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'cli'
        run: |
          cd packages/cli
          python -m build
          ls -la dist/

      - name: Build dockrion (meta-package)
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'dockrion'
        run: |
          cd packages/dockrion
          python -m build
          ls -la dist/

      - name: Upload common-py artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'common-py'
        uses: actions/upload-artifact@v4
        with:
          name: dist-common-py
          path: packages/common-py/dist/

      - name: Upload telemetry artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'telemetry'
        uses: actions/upload-artifact@v4
        with:
          name: dist-telemetry
          path: packages/telemetry/dist/

      - name: Upload schema artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'schema'
        uses: actions/upload-artifact@v4
        with:
          name: dist-schema
          path: packages/schema/dist/

      - name: Upload policy-engine artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'policy-engine'
        uses: actions/upload-artifact@v4
        with:
          name: dist-policy-engine
          path: packages/policy-engine/dist/

      - name: Upload adapters artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'adapters'
        uses: actions/upload-artifact@v4
        with:
          name: dist-adapters
          path: packages/adapters/dist/

      - name: Upload runtime artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'runtime'
        uses: actions/upload-artifact@v4
        with:
          name: dist-runtime
          path: packages/runtime/dist/

      - name: Upload sdk-python artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'sdk-python'
        uses: actions/upload-artifact@v4
        with:
          name: dist-sdk-python
          path: packages/sdk-python/dist/

      - name: Upload cli artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'cli'
        uses: actions/upload-artifact@v4
        with:
          name: dist-cli
          path: packages/cli/dist/

      - name: Upload dockrion artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'dockrion'
        uses: actions/upload-artifact@v4
        with:
          name: dist-dockrion
          path: packages/dockrion/dist/

  # Publish base packages (no internal dependencies)
  publish-base:
    name: Publish Base Packages
    needs: build
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write  # Required for trusted publishing
      contents: read

    steps:
      - name: Download common-py artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'common-py'
        uses: actions/download-artifact@v4
        with:
          name: dist-common-py
          path: dist-common-py/
        continue-on-error: true

      - name: Download telemetry artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'telemetry'
        uses: actions/download-artifact@v4
        with:
          name: dist-telemetry
          path: dist-telemetry/
        continue-on-error: true

      # Publish with API Token (for first publish)
      - name: Publish dockrion-common to PyPI (Token)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'common-py') && github.event.inputs.use_token == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-common-py/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
          verbose: true
        continue-on-error: true

      - name: Publish dockrion-telemetry to PyPI (Token)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'telemetry') && github.event.inputs.use_token == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-telemetry/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
          verbose: true
        continue-on-error: true

      # Publish with Trusted Publisher (after packages exist)
      - name: Publish dockrion-common to PyPI (Trusted)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'common-py') && github.event.inputs.use_token != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-common-py/
          skip-existing: true
          verbose: true
        continue-on-error: true

      - name: Publish dockrion-telemetry to PyPI (Trusted)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'telemetry') && github.event.inputs.use_token != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-telemetry/
          skip-existing: true
          verbose: true
        continue-on-error: true

  # Publish tier 2 packages (depend on common)
  publish-tier2:
    name: Publish Tier 2 Packages
    needs: publish-base
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download schema artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'schema'
        uses: actions/download-artifact@v4
        with:
          name: dist-schema
          path: dist-schema/
        continue-on-error: true

      - name: Download policy-engine artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'policy-engine'
        uses: actions/download-artifact@v4
        with:
          name: dist-policy-engine
          path: dist-policy-engine/
        continue-on-error: true

      - name: Download adapters artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'adapters'
        uses: actions/download-artifact@v4
        with:
          name: dist-adapters
          path: dist-adapters/
        continue-on-error: true

      # Publish with API Token
      - name: Publish dockrion-schema to PyPI (Token)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'schema') && github.event.inputs.use_token == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-schema/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
          verbose: true
        continue-on-error: true

      - name: Publish dockrion-policy to PyPI (Token)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'policy-engine') && github.event.inputs.use_token == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-policy-engine/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
          verbose: true
        continue-on-error: true

      - name: Publish dockrion-adapters to PyPI (Token)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'adapters') && github.event.inputs.use_token == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-adapters/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
          verbose: true
        continue-on-error: true

      # Publish with Trusted Publisher
      - name: Publish dockrion-schema to PyPI (Trusted)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'schema') && github.event.inputs.use_token != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-schema/
          skip-existing: true
          verbose: true
        continue-on-error: true

      - name: Publish dockrion-policy to PyPI (Trusted)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'policy-engine') && github.event.inputs.use_token != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-policy-engine/
          skip-existing: true
          verbose: true
        continue-on-error: true

      - name: Publish dockrion-adapters to PyPI (Trusted)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'adapters') && github.event.inputs.use_token != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-adapters/
          skip-existing: true
          verbose: true
        continue-on-error: true

  # Publish tier 3 packages (depend on schema, adapters)
  publish-tier3:
    name: Publish Tier 3 Packages
    needs: publish-tier2
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download runtime artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'runtime'
        uses: actions/download-artifact@v4
        with:
          name: dist-runtime
          path: dist-runtime/
        continue-on-error: true

      - name: Download sdk-python artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'sdk-python'
        uses: actions/download-artifact@v4
        with:
          name: dist-sdk-python
          path: dist-sdk-python/
        continue-on-error: true

      # Publish with API Token
      - name: Publish dockrion-runtime to PyPI (Token)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'runtime') && github.event.inputs.use_token == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-runtime/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
          verbose: true
        continue-on-error: true

      - name: Publish dockrion-sdk to PyPI (Token)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'sdk-python') && github.event.inputs.use_token == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-sdk-python/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
          verbose: true
        continue-on-error: true

      # Publish with Trusted Publisher
      - name: Publish dockrion-runtime to PyPI (Trusted)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'runtime') && github.event.inputs.use_token != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-runtime/
          skip-existing: true
          verbose: true
        continue-on-error: true

      - name: Publish dockrion-sdk to PyPI (Trusted)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'sdk-python') && github.event.inputs.use_token != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-sdk-python/
          skip-existing: true
          verbose: true
        continue-on-error: true

  # Publish CLI (depends on SDK)
  publish-cli:
    name: Publish CLI Package
    needs: publish-tier3
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download cli artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'cli'
        uses: actions/download-artifact@v4
        with:
          name: dist-cli
          path: dist-cli/
        continue-on-error: true

      # Publish with API Token
      - name: Publish dockrion-cli to PyPI (Token)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'cli') && github.event.inputs.use_token == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-cli/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
          verbose: true
        continue-on-error: true

      # Publish with Trusted Publisher
      - name: Publish dockrion-cli to PyPI (Trusted)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'cli') && github.event.inputs.use_token != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-cli/
          skip-existing: true
          verbose: true
        continue-on-error: true

  # Publish dockrion meta-package (depends on CLI)
  publish-dockrion:
    name: Publish Dockrion Meta-Package
    needs: publish-cli
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download dockrion artifacts
        if: github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'dockrion'
        uses: actions/download-artifact@v4
        with:
          name: dist-dockrion
          path: dist-dockrion/
        continue-on-error: true

      # Publish with API Token
      - name: Publish dockrion to PyPI (Token)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'dockrion') && github.event.inputs.use_token == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-dockrion/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
          verbose: true
        continue-on-error: true

      # Publish with Trusted Publisher
      - name: Publish dockrion to PyPI (Trusted)
        if: (github.event_name == 'release' || github.event.inputs.package == 'all' || github.event.inputs.package == 'dockrion') && github.event.inputs.use_token != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-dockrion/
          skip-existing: true
          verbose: true
        continue-on-error: true
